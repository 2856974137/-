<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>H5GG Fixed Size Script</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: transparent;
            font-family: 'Segoe UI', sans-serif;
            overflow: hidden;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }

        #container {
            width: 100%;
            height: 100%;
            background: rgba(3, 15, 30, 0.75);
            border-radius: 10px;
            box-sizing: border-box;
            padding: 4px 4px 2px 4px;
            display: flex;
            flex-direction: column;
            align-items: center;
            border: 1px solid rgba(0, 255, 255, 0.2);
            backdrop-filter: blur(4px);
            gap: 2px;
        }

        .title {
            color: #E0F8FF;
            font-size: 11px;
            font-weight: 600;
            margin: 2px 0;
            text-align: center;
            text-shadow: 0 0 5px rgba(0, 255, 255, 0.5);
            flex-shrink: 0;
        }

        .btn {
            width: 94%;
            padding: 4px 0;
            margin: 1px 0;
            background: rgba(0, 30, 50, 0.5);
            border: 1px solid rgba(0, 255, 255, 0.3);
            color: #E0F8FF;
            font-size: 10px;
            font-weight: 500;
            border-radius: 4px;
            cursor: pointer;
            text-align: center;
            outline: none;
            transition: all 0.1s ease;
            box-shadow: inset 0 1px 2px rgba(0, 255, 255, 0.1);
            flex-shrink: 0;
        }

        .btn:hover {
            background: rgba(0, 80, 120, 0.4);
            border-color: rgba(0, 255, 255, 0.6);
            transform: scale(1.01);
        }

        .btn:active {
            background: rgba(0, 50, 80, 0.6);
            transform: scale(0.99);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        #addressBox {
            width: 94%;
            padding: 3px 0;
            margin: 0;
            background: rgba(0, 10, 20, 0.6);
            border: 1px solid rgba(0, 255, 255, 0.3);
            color: #00FFFF;
            font-size: 10px;
            text-align: center;
            border-radius: 4px;
            min-height: 12px;
            cursor: pointer;
            user-select: all;
            flex-shrink: 0;
            box-sizing: border-box;
        }

        /* 状态样式扩展 */
        .loading { color: #FFAA00 !important; }
        .success { color: #00FF88 !important; }
        .error { color: #FF4444 !important; }
    </style>
</head>
<body>
    <div id="container">
        <div class="title" id="mainTitle">H5GG 控制台</div>
        <button class="btn" id="btn1">功能一 (写入内存)</button>
        <button class="btn" id="btn2">功能二 (搜索数值)</button>
        <button class="btn" id="btn3">功能三 (加载远程)</button>
        <div id="addressBox">点击功能按钮获取地址</div>
    </div>

    <script>
        let currentAddress = null;
        let h5ggReady = false; // 标记H5GG环境是否就绪
        const addressBox = document.getElementById('addressBox');
        const REMOTE_SCRIPT_URL = "https://1oe.top/666.html"; // 替换为实际远程地址

        // 初始化函数
        window.onload = function() {
            const FIXED_WIDTH = 200;
            const FIXED_HEIGHT = 150;

            // 初始化窗口
            setWindowRect(0, 0, FIXED_WIDTH, FIXED_HEIGHT);
            setWindowDrag(0, 0, FIXED_WIDTH, FIXED_HEIGHT);
            setWindowTouch(true);

            setLayoutAction(function(screenWidth, screenHeight) {
                let centerX = (screenWidth - FIXED_WIDTH) / 2;
                let centerY = (screenHeight - FIXED_HEIGHT) / 2;
                setWindowRect(centerX, centerY, FIXED_WIDTH, FIXED_HEIGHT);
                setWindowVisible(true);
            });

            // 绑定基础事件
            bindBaseEvents();
            
            // 检查H5GG环境
            checkH5GGEnvironment();
            
            // 绑定功能按钮事件
            bindFunctionButtons();
        };

        /**
         * 检查H5GG环境是否就绪
         */
        function checkH5GGEnvironment() {
            try {
                // 检测核心API是否存在
                if (typeof h5gg !== 'undefined' && h5gg.getRangesList) {
                    h5ggReady = true;
                    updateAddressBox("环境就绪 ✔️", "success");
                } else {
                    throw new Error("H5GG核心API未加载");
                }
            } catch (e) {
                h5ggReady = false;
                updateAddressBox("环境异常: " + e.message, "error");
                console.error("H5GG环境检查失败:", e);
            }
        }

        /**
         * 绑定基础事件（复制、禁止选择等）
         */
        function bindBaseEvents() {
            // 禁止文本选择和拖动
            document.body.onselectstart = document.body.ondragstart = () => false;
            
            // 地址框复制事件
            addressBox.onclick = copyAddress;
        }

        /**
         * 绑定功能按钮事件
         */
        function bindFunctionButtons() {
            // 功能一：原有内存写入
            document.getElementById('btn1').onclick = function() {
                if (!checkH5GGReady()) return;
                executeFunction1();
            };

            // 功能二：原有数值搜索
            document.getElementById('btn2').onclick = function() {
                if (!checkH5GGReady()) return;
                executeFunction2();
            };

            // 功能三：修复后的远程加载
            document.getElementById('btn3').onclick = function() {
                this.disabled = true;
                loadRemoteScript(REMOTE_SCRIPT_URL, 3) // 最多重试3次
                    .then(() => {
                        updateAddressBox("远程功能加载成功 ✔️", "success");
                    })
                    .catch((err) => {
                        updateAddressBox("加载失败: " + err.message, "error");
                    })
                    .finally(() => {
                        this.disabled = false;
                    });
            };
        }

        /**
         * 检查H5GG是否就绪，未就绪则提示
         * @returns {boolean}
         */
        function checkH5GGReady() {
            if (!h5ggReady) {
                updateAddressBox("H5GG环境未就绪 ❌", "error");
                return false;
            }
            return true;
        }

        /**
         * 加载远程脚本（带重试和超时）
         * @param {string} url 远程脚本地址
         * @param {number} maxRetry 最大重试次数
         * @param {number} timeout 超时时间(ms)
         * @returns {Promise}
         */
        function loadRemoteScript(url, maxRetry = 1, timeout = 5000) {
            return new Promise((resolve, reject) => {
                // 递归重试逻辑
                const loadWithRetry = (retryCount) => {
                    updateAddressBox(`加载远程脚本(${retryCount}/${maxRetry})...`, "loading");
                    
                    // 创建脚本标签
                    const script = document.createElement('script');
                    script.type = 'text/javascript';
                    script.async = true;

                    // 超时处理
                    const timeoutTimer = setTimeout(() => {
                        script.remove();
                        if (retryCount < maxRetry) {
                            setTimeout(() => loadWithRetry(retryCount + 1), 1000);
                        } else {
                            reject(new Error("加载超时"));
                        }
                    }, timeout);

                    // 加载成功
                    script.onload = () => {
                        clearTimeout(timeoutTimer);
                        resolve();
                    };

                    // 加载失败
                    script.onerror = () => {
                        clearTimeout(timeoutTimer);
                        script.remove();
                        if (retryCount < maxRetry) {
                            setTimeout(() => loadWithRetry(retryCount + 1), 1000);
                        } else {
                            reject(new Error("脚本加载失败"));
                        }
                    };

                    // 设置地址并插入
                    script.src = url;
                    document.head.appendChild(script);
                };

                // 开始第一次加载
                loadWithRetry(1);
            });
        }

        // ========== 原有功能封装 ==========
        function executeFunction1() {
            try {
                var X = h5gg.getRangesList(0);
                if (!X || !X[0] || typeof X[0].start === 'undefined') {
                    throw new Error("无法获取基址");
                }

                var addr = Number(X[0].start) + 0x192D09C;
                fuckbase(addr, "01198052012000B9");
                updateDisplayedAddress(addr);
                updateAddressBox("功能一执行成功", "success");
            } catch (e) {
                updateAddressBox("功能一错误: " + e.message, "error");
                console.error("功能一执行失败:", e);
            }
        }

        function executeFunction2() {
            try {
                h5gg.clearResults();
                h5gg.searchNumber('100', 'I32');

                let count = h5gg.getResultsCount();
                if (count > 0) {
                    let results = h5gg.getResults(1, 0);
                    updateDisplayedAddress(results[0].address);
                    updateAddressBox(`找到 ${count} 个结果`, "success");
                } else {
                    updateAddressBox("功能二: 未找到数值", "error");
                }
                h5gg.clearResults();
            } catch (e) {
                updateAddressBox("功能二错误: " + e.message, "error");
                console.error("功能二执行失败:", e);
            }
        }

        // ========== 工具函数 ==========
        /**
         * 更新地址框显示
         * @param {string} text 显示文本
         * @param {string} type 状态类型: success/error/loading/default
         */
        function updateAddressBox(text, type = "default") {
            addressBox.textContent = text;
            addressBox.className = type;
        }

        /**
         * 更新显示的地址
         * @param {number|string} address 内存地址
         */
        function updateDisplayedAddress(address) {
            if (!address) return;
            currentAddress = Number(address).toString(16).toUpperCase();
            updateAddressBox("点击复制地址: 0x" + currentAddress);
        }

        /**
         * 内存写入函数
         * @param {number} addr 地址
         * @param {string} hex 十六进制字符串
         */
        function fuckbase(addr, hex) {
            for (var i = 0; i < hex.length / 2; i++) {
                var item = parseInt(hex.substring(i * 2, i * 2 + 2), 16);
                h5gg.setValue(addr + i, item, "U8");
            }
        }

        /**
         * 复制地址（带兼容和反馈）
         */
        function copyAddress() {
            if (!currentAddress) {
                updateAddressBox("暂无地址可复制", "error");
                return;
            }

            const fullAddress = "0x" + currentAddress;

            // 优先使用现代API
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(fullAddress)
                    .then(() => {
                        updateAddressBox("✅ 已复制: " + fullAddress, "success");
                        resetAddressBoxAfterDelay();
                    })
                    .catch(() => fallbackCopy(fullAddress));
            } else {
                fallbackCopy(fullAddress);
            }
        }

        /**
         * 旧版浏览器兼容复制
         * @param {string} text 要复制的文本
         */
        function fallbackCopy(text) {
            try {
                const textarea = document.createElement("textarea");
                textarea.value = text;
                textarea.style.position = 'fixed';
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand("copy");
                document.body.removeChild(textarea);

                updateAddressBox("✅ 已复制: " + text, "success");
                resetAddressBoxAfterDelay();
            } catch (e) {
                updateAddressBox("复制失败，请手动复制", "error");
                console.error("复制失败:", e);
            }
        }

        /**
         * 延迟重置地址框显示
         */
        function resetAddressBoxAfterDelay() {
            setTimeout(() => {
                if (currentAddress) {
                    updateDisplayedAddress(currentAddress);
                } else {
                    updateAddressBox("点击功能按钮获取地址");
                }
            }, 1500);
        }
    </script>
</body>
</html>
